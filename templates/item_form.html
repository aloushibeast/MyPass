{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        {% if item_type == "LOGIN" %}
          <h3 class="card-title mb-3">
            {% if mode == "edit" %}Edit Login{% else %}Add Login{% endif %}
          </h3>
          <form method="post">
            <div class="mb-3">
              <label class="form-label">Label</label>
              <input class="form-control" type="text" name="label"
                     value="{{ item.label if item else '' }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Username</label>
              <input class="form-control" type="text" name="username"
                     value="{{ item.username if item else '' }}">
            </div>

            <div class="mb-3">
              <label class="form-label">Password</label>
              <div class="input-group">
                <input class="form-control" type="text" id="password-field" name="password"
                       value="{{ item.password if item else '' }}">
                <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">Generate</button>
              </div>

              <!-- strength meter -->
              <div class="mt-2">
                <div class="progress" style="height: 6px;">
                  <div id="login-password-strength-bar" class="progress-bar"
                       role="progressbar" style="width: 0%;"
                       aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                <small id="login-password-strength-text" class="text-muted">
                  Enter or generate a password to see its strength.
                </small>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">URL</label>
              <input class="form-control" type="url" name="url"
                     value="{{ item.url if item else '' }}">
            </div>

            <button class="btn btn-primary w-100" type="submit">
              {% if mode == "edit" %}Update{% else %}Save{% endif %}
            </button>
          </form>

        {% elif item_type == "CREDIT_CARD" %}
          <h3 class="card-title mb-3">
            {% if mode == "edit" %}Edit Credit Card{% else %}Add Credit Card{% endif %}
          </h3>
          <form method="post">
            <div class="mb-3">
              <label class="form-label">Label</label>
              <input class="form-control" type="text" name="label"
                     value="{{ item.label if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Card Number</label>
              <input class="form-control" type="text" name="card_number"
                     value="{{ item.card_number if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Card Holder</label>
              <input class="form-control" type="text" name="card_holder"
                     value="{{ item.card_holder if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Expiry (YYYY-MM)</label>
              <input class="form-control" type="text" name="card_expiry"
                     placeholder="2026-09"
                     value="{{ item.card_expiry if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">CVV</label>
              <input class="form-control" type="text" name="card_cvv"
                     value="{{ item.card_cvv if item else '' }}" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">
              {% if mode == "edit" %}Update{% else %}Save{% endif %}
            </button>
          </form>

        {% elif item_type == "IDENTITY" %}
          <h3 class="card-title mb-3">
            {% if mode == "edit" %}Edit Identity{% else %}Add Identity{% endif %}
          </h3>
          <form method="post">
            <div class="mb-3">
              <label class="form-label">Label</label>
              <input class="form-control" type="text" name="label"
                     value="{{ item.label if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Identity Type</label>
              <input class="form-control" type="text" name="identity_type"
                     placeholder="Passport, Driver License, SSN..."
                     value="{{ item.identity_type if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Identity Number</label>
              <input class="form-control" type="text" name="identity_number"
                     value="{{ item.identity_number if item else '' }}" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">
              {% if mode == "edit" %}Update{% else %}Save{% endif %}
            </button>
          </form>

        {% elif item_type == "SECURE_NOTE" %}
          <h3 class="card-title mb-3">
            {% if mode == "edit" %}Edit Secure Note{% else %}Add Secure Note{% endif %}
          </h3>
          <form method="post">
            <div class="mb-3">
              <label class="form-label">Label</label>
              <input class="form-control" type="text" name="label"
                     value="{{ item.label if item else '' }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Note</label>
              <textarea class="form-control" name="note" rows="5" required>{{ item.note if item else '' }}</textarea>
            </div>
            <button class="btn btn-primary w-100" type="submit">
              {% if mode == "edit" %}Update{% else %}Save{% endif %}
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // password generator for login items
  function generatePassword() {
    fetch("{{ url_for('generate_password') }}", {
      method: "POST"
    })
    .then(resp => resp.json())
    .then(data => {
      const field = document.getElementById("password-field");
      field.value = data.password;
      updateLoginMeter();   // update strength after generating
    });
  }

  //strength meter for login password
  const loginPwInput = document.getElementById("password-field");
  const loginBar = document.getElementById("login-password-strength-bar");
  const loginText = document.getElementById("login-password-strength-text");

  function evaluateStrength(pw) {
    let score = 0;

    if (pw.length >= 8) score++;
    if (pw.length >= 12) score++;
    if (/[a-z]/.test(pw)) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;

    return score; // 0â€“6
  }

  function updateLoginMeter() {
    if (!loginPwInput || !loginBar || !loginText) return;

    const pw = loginPwInput.value || "";
    const score = evaluateStrength(pw);

    let width = 0;
    let label = "Too weak";
    let cls = "bg-danger";

    if (pw.length === 0) {
      width = 0;
      label = "Enter or generate a password to see its strength.";
      cls = "bg-danger";
    } else if (score <= 2) {
      width = 25;
      label = "Weak";
      cls = "bg-danger";
    } else if (score <= 4) {
      width = 60;
      label = "Medium";
      cls = "bg-warning";
    } else if (score <= 5) {
      width = 85;
      label = "Strong";
      cls = "bg-success";
    } else {
      width = 100;
      label = "Very strong";
      cls = "bg-success";
    }

    loginBar.style.width = width + "%";
    loginBar.className = "progress-bar " + cls;
    loginBar.setAttribute("aria-valuenow", width);
    loginText.textContent = label;
  }

  if (loginPwInput) {
    loginPwInput.addEventListener("input", updateLoginMeter);
    // initialize on load with existing value if editing
    if (loginPwInput.value) {
      updateLoginMeter();
    }
  }
</script>
{% endblock %}
